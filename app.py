import streamlit as st
import google.generativeai as genai
import os

# Gemini ëª¨ë¸ ì„¤ì •
# API í‚¤ëŠ” ì§ì ‘ ë…¸ì¶œë³´ë‹¤ëŠ” í™˜ê²½ ë³€ìˆ˜ ë“±ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
# ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” Streamlit Secrets (secrets.toml)ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜,
# í™˜ê²½ ë³€ìˆ˜ë¥¼ í†µí•´ ì£¼ì…í•˜ëŠ” ë°©ì‹ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
try:
    # í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ ë¡œë“œ ì‹œë„
    # os.getenvë¡œ í™˜ê²½ ë³€ìˆ˜ë„ ê³ ë ¤í•  ìˆ˜ ìˆì§€ë§Œ, Streamlit Cloud ë°°í¬ ì‹œì—ëŠ” st.secretsê°€ ì¼ë°˜ì ì…ë‹ˆë‹¤.
    # ì—¬ê¸°ì„œëŠ” st.secretsë§Œ ì‚¬ìš©í•˜ë„ë¡ ì½”ë“œë¥¼ ê°„ê²°í•˜ê²Œ í–ˆìŠµë‹ˆë‹¤.
    api_key = st.secrets["GOOGLE_API_KEY"]

    if not api_key:
         # API í‚¤ê°€ ì—¬ì „íˆ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ë°œìƒ (secretsì— ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°)
        st.error("Streamlit Secretsì— 'GOOGLE_API_KEY'ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        st.stop() # ì•± ì‹¤í–‰ ì¤‘ë‹¨

    genai.configure(api_key=api_key)

except KeyError:
     # st.secrets["GOOGLE_API_KEY"] ì ‘ê·¼ ì‹œ í‚¤ê°€ ì—†ì„ ê²½ìš° ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ ì²˜ë¦¬
     st.error("Streamlit Secretsì— 'GOOGLE_API_KEY'ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì•± ì„¤ì •ì—ì„œ Secretsë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
     st.stop()
except Exception as e:
    st.error(f"API í‚¤ ì„¤ì • ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: {e}")
    st.stop()


# ì´ˆë“±í•™ìƒ ëˆˆë†’ì´ì— ë§ëŠ” ë‹µë³€ì„ ìœ„í•œ ì‹œìŠ¤í…œ ëª…ë ¹ì–´ ì„¤ì • (ê·¸ë¦¼/ì‚¬ì§„ì— ëŒ€í•œ ì¡°ì–¸ ì´ˆì  + ê°œì„ ì  í¬í•¨)
system_instruction_text = """
ë‹¹ì‹ ì€ ì´ˆë“±í•™ìƒ ì¹œêµ¬ë“¤ì„ ìœ„í•œ ì¹œì ˆí•œ ê·¸ë¦¼ ì„ ìƒë‹˜ ë„ìš°ë¯¸ì˜ˆìš”!
ì¹œêµ¬ë“¤ì´ ì˜¬ë¦° ê·¸ë¦¼ì´ë‚˜ ì‚¬ì§„ì„ ë³´ê³ , ì¬ë¯¸ìˆê±°ë‚˜ ë©‹ì§„ ì ì„ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”.

**ë¨¼ì €, ê·¸ë¦¼ì˜ ì¢‹ì€ ì ì„ ì¶©ë¶„íˆ ì¹­ì°¬í•´ì£¼ì„¸ìš”.** ìƒ‰ê¹”ì„ ì˜ˆì˜ê²Œ ì¼ë‹¤ê±°ë‚˜, ì¬ë¯¸ìˆëŠ” ìƒìƒì„ í–ˆë‹¤ê±°ë‚˜, ì—´ì‹¬íˆ ê·¸ë¦° ë¶€ë¶„ ë“± ì¹­ì°¬í•  ì ì„ êµ¬ì²´ì ìœ¼ë¡œ ì°¾ì•„ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”.

**ì¹œêµ¬ì˜ ê·¸ë¦¼/ì‚¬ì§„ì„ ì˜ ì‚´í´ë´ ì£¼ì„¸ìš”.** ê·¸ë¦¼ì„ ë” í’ì„±í•˜ê³  ì¬ë¯¸ìˆê²Œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì•„ì´ë””ì–´ê°€ ë– ì˜¤ë¥¸ë‹¤ë©´ (ì˜ˆ: ë¹„ì–´ ìˆëŠ” ë°°ê²½, ë¶€ì¡±í•œ ìƒ‰ì¹ , ì´ì•¼ê¸° ì¶”ê°€ ë“±), **ê·¸ë•Œ** ì•„ì£¼ ë¶€ë“œëŸ½ê³  ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ê°œì„  ì•„ì´ë””ì–´ë¥¼ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”.

**í•˜ì§€ë§Œ ë§Œì•½ ê·¸ë¦¼ì´ ì´ë¯¸ ë©‹ì§€ê²Œ ì™„ì„±ë˜ì–´ ìˆê±°ë‚˜, ì¶”ê°€ ì¡°ì–¸ì´ ì–´ìš¸ë¦¬ì§€ ì•ŠëŠ” ê²½ìš°ë¼ë©´, ê°œì„  ì•„ì´ë””ì–´ëŠ” ìƒëµí•˜ê³  ì¹­ì°¬ìœ¼ë¡œë§Œ ë§ˆë¬´ë¦¬í•´ë„ ê´œì°®ìŠµë‹ˆë‹¤.**

**ì ˆëŒ€ 'í‹€ë ¸ë‹¤', 'ì´ìƒí•˜ë‹¤', 'ë‚˜ì˜ë‹¤' ê°™ì€ ë¶€ì •ì ì¸ ë§ì€ ì‚¬ìš©í•˜ì§€ ì•Šì•„ìš”.** í•­ìƒ 'ì´ë ‡ê²Œ í•´ë³´ë©´ ë” ë©‹ì ¸ì§ˆ ê±°ì•¼!' ì™€ ê°™ì´ ê¸ì •ì ìœ¼ë¡œ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”.

ì–´ë ¤ìš´ ë‹¨ì–´ëŠ” ì“°ì§€ ë§ê³ , ì´ˆë“±í•™ìƒ ì¹œêµ¬ë“¤ì´ ê¸°ë¶„ ì¢‹ê²Œ ì´í•´í•˜ê³  ë‹¤ìŒì— ê·¸ë¦¼ ê·¸ë¦´ ë•Œ ë„ì›€ì´ ë  ìˆ˜ ìˆë„ë¡ ìƒëƒ¥í•˜ê³  ë”°ëœ»í•˜ê²Œ ë§í•´ì£¼ì„¸ìš”.
"""

# ì‚¬ìš©í•  ëª¨ë¸ ì§€ì • ë° ì‹œìŠ¤í…œ ëª…ë ¹ì–´ ì ìš©
model = genai.GenerativeModel(
    'gemini-1.5-flash-latest', # ë¹„ì „(ì´ë¯¸ì§€) ì²˜ë¦¬ê°€ ê°€ëŠ¥í•œ ëª¨ë¸ ì‚¬ìš©
    system_instruction=system_instruction_text
)

st.title("ê³¡ìˆ˜ì´ˆ Oí•™ë…„ ê·¸ë¦¼ ì´ì•¼ê¸° ì±—ë´‡~")

# ì±„íŒ… ê¸°ë¡ ì´ˆê¸°í™” (í‘œì‹œìš© - í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ í•¨ê»˜ ì €ì¥)
if "messages" not in st.session_state:
    st.session_state["messages"] = [{"role": "assistant", "content": "ì•ˆë…•! ê·¸ë¦¼ì´ë‚˜ ì‚¬ì§„ì„ ì˜¬ë¦¬ê±°ë‚˜ ì¹´ë©”ë¼ë¡œ ì°ì–´ì„œ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì„ ìƒë‹˜ì´ ë©‹ì§„ ì ê³¼ ë” ì¬ë¯¸ìˆê²Œ ê·¸ë¦´ ì•„ì´ë””ì–´ë¥¼ ì´ì•¼ê¸°í•´ì¤„ê²Œ!", "type": "text"}]

# ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ
for message in st.session_state["messages"]:
    with st.chat_message(message["role"]):
        if message["type"] == "text":
            st.markdown(message["content"])
        elif message["type"] == "image":
            # Streamlitì˜ ì´ë¯¸ì§€ í‘œì‹œ ê¸°ëŠ¥ ì‚¬ìš©
            # ì´ë¯¸ì§€ ë°”ì´íŠ¸ ë°ì´í„°ë¥¼ st.imageë¡œ ë°”ë¡œ í‘œì‹œ
            st.image(message["content"], caption="ì¹œêµ¬ ê·¸ë¦¼/ì‚¬ì§„", use_container_width=True)

# --- ëª¨ë“œ ì„ íƒì„ ìœ„í•œ ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸°í™” ---
# Trueì´ë©´ ì¹´ë©”ë¼ ëª¨ë“œ, Falseì´ë©´ íŒŒì¼ ì—…ë¡œë“œ ëª¨ë“œ
if 'use_camera' not in st.session_state:
    st.session_state['use_camera'] = False

# --- ëª¨ë“œ ì„ íƒ ë²„íŠ¼ ---
# í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•˜ê³ , í´ë¦­ ì‹œ ëª¨ë“œ ìƒíƒœë¥¼ í† ê¸€
if st.button("ğŸ“¸ ì¹´ë©”ë¼ë¡œ ì°ê¸°" if not st.session_state['use_camera'] else "ğŸ“ íŒŒì¼ë¡œ ì˜¬ë¦¬ê¸°"):
    st.session_state['use_camera'] = not st.session_state['use_camera']
    st.rerun() # ëª¨ë“œ ë³€ê²½ í›„ UI ê°±ì‹ ì„ ìœ„í•´ ì¬ì‹¤í–‰

# ì´ë¯¸ì§€ ì—…ë¡œë“œ ë˜ëŠ” ì¹´ë©”ë¼ ì´¬ì˜ì„ ìœ„í•œ í¼
# ì„ íƒëœ ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥¸ ì…ë ¥ ìœ„ì ¯ì´ í¼ ì•ˆì— í‘œì‹œë©ë‹ˆë‹¤.
with st.form(key="image_upload_form") as form:
    st.write(f"ğŸ’¡ í˜„ì¬ ëª¨ë“œ: {'ì¹´ë©”ë¼ ì´¬ì˜' if st.session_state['use_camera'] else 'íŒŒì¼ ì—…ë¡œë“œ'}")

    image_to_process = None # ì²˜ë¦¬í•  ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ë‹´ì„ ë³€ìˆ˜
    image_mime_type = None # ì´ë¯¸ì§€ ë§ˆì„ íƒ€ì…ì„ ë‹´ì„ ë³€ìˆ˜
    input_widget_key = "current_image_input" # í˜„ì¬ í™œì„±í™”ëœ ì…ë ¥ ìœ„ì ¯ì˜ ê³ ìœ  í‚¤

    # --- ì„ íƒëœ ëª¨ë“œì— ë”°ë¼ ì…ë ¥ ìœ„ì ¯ ì¡°ê±´ë¶€ í‘œì‹œ ---
    if st.session_state['use_camera']:
        # ì¹´ë©”ë¼ ëª¨ë“œì¼ ë•Œ ì¹´ë©”ë¼ ì…ë ¥ ìœ„ì ¯ í‘œì‹œ
        camera_image = st.camera_input("ì¹´ë©”ë¼ë¡œ ê·¸ë¦¼/ì‚¬ì§„ ì°ê¸°", key=input_widget_key)

        # --- ì¶”ê°€ëœ ë¶€ë¶„: ì¹´ë©”ë¼ ë²„íŠ¼ ì„¤ëª… ---
        if st.session_state['use_camera']:
             st.info("ì¹´ë©”ë¼ê°€ ì¼œì§€ë©´ ë³´ì´ëŠ” í™”ë©´ì—ì„œ [Take Photo] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‚¬ì§„ì„ ì°ê³ , [Clear photo] ë²„íŠ¼ì€ ì°ì€ ì‚¬ì§„ì„ ë‹¤ì‹œ ì§€ìš¸ ë•Œ ì‚¬ìš©í•´ìš”.")
        # ------------------------------------

        if camera_image is not None:
            image_to_process = camera_image.getvalue()
            image_mime_type = camera_image.type


    else:
        # íŒŒì¼ ì—…ë¡œë“œ ëª¨ë“œì¼ ë•Œ íŒŒì¼ ì—…ë¡œë” ìœ„ì ¯ í‘œì‹œ
        uploaded_file = st.file_uploader("ì»´í“¨í„°ì—ì„œ ê·¸ë¦¼/ì‚¬ì§„ ì˜¬ë¦¬ê¸°", type=["png", "jpg", "jpeg", "gif"], key=input_widget_key)
        if uploaded_file is not None:
            image_to_process = uploaded_file.getvalue()
            image_mime_type = uploaded_file.type


    # ì œì¶œ ë²„íŠ¼
    submit_button = st.form_submit_button("ì„ ìƒë‹˜ê»˜ ê·¸ë¦¼/ì‚¬ì§„ ë³´ì—¬ì£¼ê¸°!")

    # 'ë³´ì—¬ì£¼ê¸°' ë²„íŠ¼ì´ ëˆŒë ¸ì„ ë•Œ ì²˜ë¦¬ ì‹œì‘
    if submit_button:
        # ì´ ì‹œì ì—ì„œ image_to_processì™€ image_mime_type ë³€ìˆ˜ì— ì´ë¯¸ ê°’ì´ í• ë‹¹ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (ì…ë ¥ ìœ„ì ¯ì— íŒŒì¼/ì‚¬ì§„ì´ ìˆë‹¤ë©´).

        if image_to_process is not None and image_mime_type is not None:
            # ì‚¬ìš©ìì˜ ì…ë ¥ (ì´ë¯¸ì§€)ì„ ì±„íŒ… ê¸°ë¡ì— ì¶”ê°€ (í‘œì‹œìš©)
            st.session_state["messages"].append({"role": "user", "content": image_to_process, "type": "image"})

            # AIì—ê²Œ ì „ë‹¬í•  ì´ë¯¸ì§€ ë° í…ìŠ¤íŠ¸ ë‚´ìš© êµ¬ì„±
            content = [
                {"mime_type": image_mime_type, "data": image_to_process},
                "ì´ ê·¸ë¦¼/ì‚¬ì§„ì„ ë³´ê³  ì´ˆë“±í•™ìƒ ì¹œêµ¬ì—ê²Œ ì´ì•¼ê¸°í•˜ë“¯ì´ ì„¤ëª…í•´ì¤˜. ë¨¼ì € ê·¸ë¦¼ì˜ ë©‹ì§„ ì ì„ ì¶©ë¶„íˆ ì¹­ì°¬í•´ì£¼ê³ , ë§Œì•½ í•„ìš”í•˜ë‹¤ë©´ ë” ë©‹ì ¸ì§ˆ ìˆ˜ ìˆëŠ” ë¶€ë¶„ì„ ë¶€ë“œëŸ½ê²Œ ì¡°ì–¸í•´ì¤˜. ë„¤ê°€ ì´ˆë“±í•™ìƒ ì¹œêµ¬ì—ê²Œ ë§í•˜ë“¯ì´ ì¹œì ˆí•˜ê³  ìƒëƒ¥í•˜ê²Œ ì´ì•¼ê¸°í•´ì•¼ í•´."
            ]

            # AI ì‘ë‹µ ìƒì„± ë° í‘œì‹œ
            with st.chat_message("assistant"):
                # ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ë™ì•ˆ ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
                with st.spinner("ì¹œêµ¬ ê·¸ë¦¼/ì‚¬ì§„ì„ ì‚´í´ë³´ê³  ìˆì–´ìš”..."):
                    try:
                        # generate_contentë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ì „ë‹¬í•˜ê³  ì‘ë‹µ ë°›ê¸°
                        response = model.generate_content(content)

                        # ì‘ë‹µ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
                        assistant_response = response.text

                        # ì±—ë´‡ ì‘ë‹µ ì €ì¥ (í‘œì‹œìš©)
                        st.session_state["messages"].append({"role": "assistant", "content": assistant_response, "type": "text"})

                        # ì±—ë´‡ ì‘ë‹µ í‘œì‹œ
                        st.markdown(assistant_response)

                        # --- Form ì´ˆê¸°í™” ---
                        # ì²˜ë¦¬ê°€ ì™„ë£Œë˜ë©´ formì˜ ì…ë ¥ í•„ë“œë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
                        # form ê°ì²´ê°€ Noneì´ ì•„ë‹Œì§€ í™•ì¸ í›„ reset í˜¸ì¶œ
                        if form is not None: # 'NoneType' ì˜¤ë¥˜ ë°©ì§€ í™•ì¸
                           form.reset()
                           # í¼ ë¦¬ì…‹ í›„, í˜„ì¬ ëª¨ë“œë¥¼ ë‹¤ì‹œ íŒŒì¼ ì—…ë¡œë“œ ëª¨ë“œë¡œ ë³€ê²½í•˜ì—¬ ì´ˆê¸° ìƒíƒœë¡œ ëŒì•„ê°€ê²Œ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
                           # st.session_state['use_camera'] = False # í•„ìš”í•˜ë‹¤ë©´ ì´ ë¼ì¸ ì¶”ê°€
                        # -------------------

                    except Exception as e:
                        # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì²˜ë¦¬
                        error_message = f"ì•—, ê·¸ë¦¼/ì‚¬ì§„ì„ ì‚´í´ë³´ë‹¤ê°€ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ê±°ë‚˜ ë‹¤ë¥¸ ê·¸ë¦¼/ì‚¬ì§„ì„ ì˜¬ë ¤ì¤„ë˜? (ì˜¤ë¥˜: {e})"
                        st.session_state["messages"].append({"role": "assistant", "content": error_message, "type": "text"})
                        st.markdown(error_message)

            # AI ì²˜ë¦¬ ë° ì‘ë‹µ í‘œì‹œ í›„ UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì•± ë‹¤ì‹œ ì‹¤í–‰
            st.rerun() # ì²˜ë¦¬ ì™„ë£Œ í›„ UI ê°±ì‹  ë° form ì´ˆê¸°í™” ì ìš©

        else:
             # ì œì¶œ ë²„íŠ¼ì„ ëˆŒë €ì§€ë§Œ, ì„ íƒëœ ëª¨ë“œì˜ ì…ë ¥ ìœ„ì ¯ì— ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš°
             if st.session_state['use_camera']:
                 st.warning("ì¹´ë©”ë¼ë¡œ ì‚¬ì§„ì„ ì°ì€ í›„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ í•´ìš”!")
             else:
                 st.warning("ê·¸ë¦¼/ì‚¬ì§„ íŒŒì¼ì„ ì˜¬ë¦° í›„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ í•´ìš”!")
